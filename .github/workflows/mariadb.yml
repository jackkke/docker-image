name: Publish MariaDB Image To Github

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  check_versions:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mariadb_major: [10.5, 10.6, 10.11, 11.4, 11.8]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Check official MariaDB version
        id: check_version
        run: |
          FILE=".github/mariadb_versions.json"
          [ -f "$FILE" ] || echo "{}" > "$FILE"
          MAJOR=${{ matrix.mariadb_major }}
          IMAGE="mariadb:$MAJOR"
          echo "ğŸ” Checking $IMAGE ..."
          docker pull $IMAGE >/dev/null
          VERSION=$(docker inspect $IMAGE | jq -r '.[0].Config.Labels["org.opencontainers.image.version"]')
          [ -z "$VERSION" ] || [ "$VERSION" = "null" ] && VERSION="unknown"
          OLD=$(jq -r --arg key "$MAJOR" '.[$key] // ""' "$FILE")
          if [ "$VERSION" != "$OLD" ]; then
            echo "âš ï¸ $MAJOR updated: $OLD -> $VERSION"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… $MAJOR unchanged ($VERSION)"
          fi
      - name: upload artifact
        if: ${{ steps.check_version.outputs.version != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-${{ steps.check_version.outputs.version }}
          path: /dev/null  # ä¸Šä¼ ç©ºæ–‡ä»¶
          retention-days: 1
  collect_and_commit:
    runs-on: ubuntu-latest
    needs: check_versions
    outputs:
      version_list: ${{ steps.collect.outputs.list }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: mariadb-*
      - name: collect artifacts
        id: collect
        run: |
          FILE=".github/mariadb_versions.json"
          [ -f "$FILE" ] || echo "{}" > "$FILE"
          LIST=()
          for f in artifacts/*; do
            name=$(basename "$f")
            VERSION=${name#mariadb-}
            MAJOR="${VERSION%.*}"
            LIST+=("$VERSION")
            jq --arg key "$MAJOR" --arg value "$VERSION" '.[$key]=$value' "$FILE" > "${FILE}.tmp" && mv "${FILE}.tmp" "$FILE"
            echo "â¡ï¸ Updated $MAJOR -> $VERSION"
          done
          if [ ${#LIST[@]} -eq 0 ]; then
            echo "list=[]" >> "$GITHUB_OUTPUT"
          else
            echo "list=$(printf '%s\n' "${LIST[@]}" | jq -R -s -c 'split("\n")[:-1]')" >> "$GITHUB_OUTPUT"
            # Git commit & push
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$FILE"
            git commit -m "Update MariaDB versions" || echo "No changes to commit"
            git push || echo "Push failed, possibly no changes"
          fi
  build_images:
    runs-on: ubuntu-latest
    needs: collect_and_commit
    if: needs.collect_and_commit.outputs.version_list != '[]'
    strategy:
      matrix:
        version: ${{ fromJson(needs.collect_and_commit.outputs.version_list) }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Prepare version
        id: prepare
        run: |
          VERSION=${{ matrix.version }}
          MAJOR=${VERSION%.*}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "MAJOR=$MAJOR" >> $GITHUB_ENV
      - name: pangu-mariadb
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          context: "{{defaultContext}}:pangu-mariadb"
          push: true
          build-args: |
            VERSION=${{ env.VERSION }}
            MARIADB_ROOT_PASSWORD=${{ secrets.MARIADB_ROOT_PASSWORD }}
            MARIADB_USER=tsoc
            MARIADB_PASSWORD=${{ secrets.MARIADB_PASSWORD }}
            MARIADB_DATABASE=tsoc
          tags: jackkke/pangu-mariadb:${{ env.VERSION }},jackkke/pangu-mariadb:${{ env.MAJOR }}
          file: Dockerfile
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mariadb-${{ env.VERSION }}
          name: MariaDB ${{ env.VERSION }}
          body: |
            âœ… é•œåƒæ„å»ºæˆåŠŸï¼
            - ä¸»ç‰ˆæœ¬: `${{ env.MAJOR }}`
            - å®Œæ•´ç‰ˆæœ¬: `${{ env.VERSION }}`
            - æ¨é€é•œåƒ: `jackkke/pangu-mariadb:${{ env.VERSION }}`,`jackkke/pangu-mariadb:${{ env.MAJOR }}`
            [æŸ¥çœ‹æ„å»ºæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}