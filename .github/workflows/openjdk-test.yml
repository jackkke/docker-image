name: Publish OpenJDK Image To DockerHub

on:
  workflow_dispatch:

jobs:
  check_versions:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openjdk_major: [8, 11, 17, 21, 25]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get Official Version
        id: check_version
        run: |
          FILE=".github/openjdk_versions.json"
          [ -f "$FILE" ] || echo "{}" > "$FILE"
          MAJOR=${{ matrix.openjdk_major }}
          docker pull alpine:latest >/dev/null
          ALPINE_VERSION=$(docker run --rm alpine:latest sh -c 'source /etc/os-release && echo $VERSION_ID')
          OPENJDK_VERSION=$(docker run --rm alpine:latest sh -c 'apk update >/dev/null 2>&1 && apk search openjdk${MAJOR}-jdk 2>/dev/null | head -1')
          FULL_VERSION=$(echo "$OPENJDK_VERSION" | awk -F'-' '{print $3"-"$4}')
          SHORT_VERSION=$(echo "$OPENJDK_VERSION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          OLD=$(jq -r --arg key "$MAJOR" '.[$key] // ""' "$FILE")
          if [ "$SHORT_VERSION" != "$OLD" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "⚠️ $MAJOR updated: $OLD -> $SHORT_VERSION"
            echo "alpine=$ALPINE_VERSION" >> "$GITHUB_OUTPUT"
            echo "full=$FULL_VERSION" >> "$GITHUB_OUTPUT"
            echo "short=$SHORT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✅ $MAJOR unchanged ($SHORT_VERSION)"
          fi
      - name: Create version info file
        if: ${{ steps.check_version.outputs.changed == 'true' }}
        run: |
          cat > openjdk-${{ steps.check_version.outputs.short }} << EOF
          ALPINE_VERSION=${{ steps.check_version.outputs.alpine }}
          MAJOR_VERSION=${{ matrix.openjdk_major }}
          FULL_VERSION=${{ steps.check_version.outputs.full }}
          SHORT_VERSION=${{ steps.check_version.outputs.short }}
          EOF
      - name: upload artifact
        if: ${{ steps.check_version.outputs.changed == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: openjdk-*
          path: artifacts/
          retention-days: 1
  collect_and_commit:
    runs-on: ubuntu-latest
    needs: check_versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: openjdk-*
      - name: collect artifacts
        if: success() && hashFiles('artifacts/*.txt') != ''
        run: |
          FILE=".github/openjdk_versions.json"
          [ -f "$FILE" ] || echo "{}" > "$FILE"
          for f in artifacts/*; do
            [ -f "$f" ] || continue
            echo "处理: $(basename "$f")"
            if source "$f" 2>/dev/null; then
              jq --arg key "$MAJOR_VERSION" --arg value "$SHORT_VERSION" '.[$key]=$value' "$FILE" > "${FILE}.tmp" && mv "${FILE}.tmp" "$FILE"
              echo "✅ 更新 JDK $MAJOR_VERSION -> $SHORT_VERSION"
            fi
          done
          # git config user.name "github-actions[bot]"
          # git config user.email "github-actions[bot]@users.noreply.github.com"
          # git add "$FILE"
          # git commit -m "Update OpenJDK versions" || echo "No changes to commit"
          # git push || echo "Push failed, possibly no changes"
